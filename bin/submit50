#!/usr/bin/env python

import argparse
import logging
import os
import requests
import signal
import sys

from submit50 import assignment, submit
from submit50 import colors

def sigint_handler(signal_number, stack_frame):
    print(colors.red('\nInterrupted.'))
    sys.exit(130)
signal.signal(signal.SIGINT, sigint_handler)

def main():
    args = parse_args(sys.argv[1:])
    configure_logging(args.verbose)
    classroom_prefix = "classroom50"
    username = get_username(args.username)
    assignment = args.assignment
    try:
        submit(f"{classroom_prefix}/{assignment}", username)
    except (AssertionError, RuntimeError, ValueError) as ex:
        logging.info(colors.red(ex))
    else:
        logging.info(colors.green(f'Successfully submitted {args.assignment}.'))
        message = f'Please visit the following link to view your submission:\n'
        url = f'https://github.com/{classroom_prefix}/{assignment}-{username}/actions'
        logging.info(colors.green(message + '\033[4m' + url + '\033[0m'))

def parse_args(args):
    parser = argparse.ArgumentParser(
        description='A git wrapper for submitting GitHub Classroom assignments.'
    )
    parser.add_argument(
        '--verbose',
        action='store_true'
    )
    parser.add_argument(
        'assignment',
        metavar='ASSIGNMENT',
        type=str,
        help='the assignment repository (e.g., classroom50/hello)'
    )
    parser.add_argument(
        'username',
        nargs='?',
        metavar='USERNAME',
        const=None,
        type=str,
        help='the github username'
    )
    
    return parser.parse_args(args)

def configure_logging(verbose):
    logging.basicConfig(format='%(message)s', level=logging.DEBUG if verbose else logging.INFO)

def get_username(username):
    if username is not None:
        return username

    try:

        # Retrieve github username using github id, this ensure
        # problem set can be submitted in the case of username change
        id = os.getenv("RepositoryName")
        url = f"https://api.github.com/user/{id}"
        return requests.get(url).json()['login']
    except:

        # If failed to retrieve username, fallbacks to extract username
        # using codespace name
        return os.getenv("CODESPACE_NAME").split("-code50")[0]


if __name__ == '__main__':
    main()
